---
title: "HW2"
format: pdf
editor_options: 
  chunk_output_type: inline
---

# Load Librarys

```{r, message=FALSE}
# Library Required packages
library(sf) # For reading spatial data
library(stars) # For reading raster data
library(tmap) # For mapping
library(tidyverse)
library(here) 
library(ggplot2)
library(dplyr)
library(patchwork) # for putting plots side by side
library(gt) # for pretty
```

# Read in data

```{r message=FALSE}

ejscreen_raw <- st_read("data/ejscreen/EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb") 

mapping_inequality_raw <- st_read('data/mapping-inequality/mapping-inequality-los-angeles.json') |> 
  st_transform(mapping_inequality_raw, crs = (st_crs(ejscreen_raw)))
  
gbif <- st_read('data/gbif-birds-LA', quiet = TRUE) |> 
   st_transform(gbif, crs = (st_crs(ejscreen_raw)))

```

## Check if CRS match

```{r}
st_crs(mapping_inequality_raw) == st_crs(gbif)  # See if CRS match
st_crs(gbif) == st_crs(ejscreen_raw)
  
```

# Part 1: Legacy of redlining in current environmental (injustice)

## Data Exploration

```{r}
head(mapping_inequality_raw) # Show first 10 rows

dim(mapping_inequality_raw) # Check size of dataframe

colnames(mapping_inequality_raw) # See column names
```

## 1. Neighborhoods by HOLC Grade

```{r}
# Create grade map
tm_shape(mapping_inequality_raw) + # Map data
  tm_graticules() + # With gridlines
  tm_polygons(fill = 'grade', # Color by grade
              fill.legend = tm_legend(title = "HOLC Grade")) + # Legend tile
  tm_title(text = "Neighborhoods by HOLC Grade") # Title
 
```

## Table Summary

```{r}
# Attach HOLC grades to each EJScreen census block group

ej_holc <- st_join(ejscreen_raw, mapping_inequality_raw) |> 
  st_drop_geometry() # Drop unneeded geometries

#glimpse(ej_holc)
#sum(is.na(ej_holc$grade))
#colnames(ej_holc)
```

```{r}
# Create table summarizing grades
ej_holc_grade_sum <- 
  ej_holc |> 
  group_by(grade) |> # Group by grade
  summarise(n_block_groups = n()) |> # Summaries by number in each group
  mutate(grade = ifelse(is.na(grade), "No Grade", grade)) |> # Change NA to None
  ungroup() |> 
  mutate( # Add column of group number out of 100%
    percent = 100 * n_block_groups / sum(n_block_groups))

ej_holc_grade_sum |> gt() |> 
  cols_hide(columns = n_block_groups) |> # Hide summarization number
  tab_header(
    title = "Grade Percentage summary table") |> 
  fmt_percent(
    columns = percent,
    scale_values = FALSE) # tell gt the values are 0-100
  
```

## Visualizations

```{r}
# Calculate mean of each variable grouped by HOLC grade.
ej_holc_means <- ej_holc |> 
  mutate(grade = ifelse(is.na(grade), "None", grade)) |>   # Replace NA with "No Grade"
  group_by(grade) |> 
  summarise(
    mean_low_income = mean(LOWINCPCT, na.rm = TRUE), # Add new columns with means
    mean_pm25 = mean(P_PM25, na.rm = TRUE),
    mean_low_life_expectancy = mean(P_LIFEEXPPCT, na.rm = TRUE)
  ) |> 
  ungroup()
```

### Plot 1: Mean of % low income

```{r}
# Plot mean of % low income by grade
plot1 <- ggplot(ej_holc_means, aes(x = grade, y = mean_low_income, fill = grade)) +
  geom_col() +
  labs(
    title = "Mean % Low Income 
    by HOLC Grade",
    x = "HOLC Grade",
    y = "Mean % Low Income"
  ) +
  theme_minimal() +
    scale_fill_brewer(palette = "Reds")
```

### Plot 2: Low life expectancy percentiles on top of Particulate matter percentiles

```{r}
# Pivot long version for plotting
ej_holc_long <- ej_holc_means |>
  pivot_longer(
    cols = c(mean_pm25, mean_low_life_expectancy), # The columns you want to plot
    names_to = "variables",                       # New column for the variables
    values_to = "percentile_means"                 # New column for the values
  )

```

```{r}
#Plot percentile of Particulate matter next to percentile of low life expectancy
plot2 <- ggplot(data = ej_holc_long, aes(x = grade, y = percentile_means, fill = variables)) +
  geom_col() + #(position = "dodge") + # geom_col for bar chart, "dodge" for side-by-side bars
  labs(
    title = "Life Expectancy 
    by HOLC Grade",
    x = "HOLC Security Grade",
    y = "Mean Percentile",
    fill = "variables"
  ) +
  
  scale_fill_manual(
    values = c("mean_pm25" = "blue", "mean_low_life_expectancy" = "red"),
    labels = c("mean_pm25" = "Particulate Matter (PM2.5)", "mean_low_life_expectancy" = "Low Life Expectancy")
  ) +
  theme_minimal()
```

```{r}
# Show plots together using patchwork
(plot1 + plot2) +
  theme(plot.margin = margin(r = 20))
```

Both plots show a clear correlation between HOLC grade and environmental injustices. While it is not surprising that lower grades of "residential security" are related to lower income, it does set a precedent for unfair environmental and socioeconomic conditions. When compared directly next to low life expectancy and particulate matter we can see that the historical redlining grades represent lower quality of life and even shorter life for people in worse graded areas. We saw how red lined districts had less trees which is likely a direct causality of worse particulate matter and therefore reasonably can be presumed to have an effect on low life expectancy.

## **Part 2: Legacy of redlining in biodiversity observations**

```{r}
# Join gbif (Bird Observation data) and mapping_inequality_raw (HOLC grade data)

HOLC_birds <- st_join(mapping_inequality_raw, gbif)
```

```{r}
# Create map of bird observations over redlining data map
tm_shape(HOLC_birds) + # Map data
  tm_graticules() + # With gridlines
  tm_polygons(fill = 'grade', # Color by grade
              fill.legend = tm_legend(title = "HOLC Grade with bird observations")) +
tm_shape(gbif) +
  tm_dots(size = 0.02,  
          fill_alpha = 0.4,
          col = "darkblue") +
  tm_title(text = "Bird observations by HOLC Grade") # Title
```

### Reflection

Here we can see a clear lack of either birds or bird observation data in red lined zones. This is clear by the appearance of yellow and blue zones that are hardly covered by bird observations in contrast with the blue and pink zones we can barely see because they are swarmed. The Diego Ellis Soto paper considers how our result may not be simply less birds, but instead less data collection going on in red lined zones in general.
